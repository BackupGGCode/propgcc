#include <stdlib.h>
#include <propeller.h>
#include "FullDuplexSerial.h"

#ifdef __GNUC__
#define INLINE__ static inline
#define Yield__() __asm__ volatile( "" ::: "memory" )
#define PostEffect__(X, Y) __extension__({ int32_t tmp__ = (X); (X) = (Y); tmp__; })
#else
#define INLINE__ static
static int32_t tmp__;
#define PostEffect__(X, Y) (tmp__ = (X), (X) = (Y), tmp__)
#define Yield__()
#endif

INLINE__ int32_t Rotl__(uint32_t a, uint32_t b) { return (a<<b) | (a>>(32-b)); }
INLINE__ int32_t Rotr__(uint32_t a, uint32_t b) { return (a>>b) | (a<<(32-b)); }
INLINE__ int32_t Lookup__(int32_t x, int32_t b, int32_t a[], int32_t n) { int32_t i = (x)-(b); return ((unsigned)i >= n) ? 0 : (a)[i]; }

uint8_t FullDuplexSerial::dat[] = {
  0xf0, 0xad, 0xbc, 0xa0, 0x10, 0xac, 0xfc, 0x80, 0x56, 0xae, 0xbc, 0x08, 0x01, 0xb6, 0xfc, 0xa0, 
  0x57, 0xb6, 0xbc, 0x2c, 0x04, 0xac, 0xfc, 0x80, 0x56, 0xae, 0xbc, 0x08, 0x01, 0xc2, 0xfc, 0xa0, 
  0x57, 0xc2, 0xbc, 0x2c, 0x04, 0xac, 0xfc, 0x80, 0x56, 0xb2, 0xbc, 0x08, 0x04, 0xac, 0xfc, 0x80, 
  0x56, 0xb4, 0xbc, 0x08, 0x04, 0xac, 0xfc, 0x80, 0x56, 0xb8, 0xbc, 0x08, 0x5c, 0xc4, 0xbc, 0xa0, 
  0x10, 0xc4, 0xfc, 0x80, 0x04, 0xb2, 0x7c, 0x62, 0x02, 0xb2, 0x7c, 0x61, 0x61, 0xe8, 0x9b, 0x68, 
  0x61, 0xec, 0xab, 0x68, 0x34, 0xcc, 0xfc, 0xa0, 0xf0, 0xab, 0x3c, 0x08, 0x66, 0xc0, 0xbc, 0x5c, 
  0x01, 0xb2, 0x7c, 0x62, 0xf2, 0xb7, 0x3c, 0x61, 0x17, 0x00, 0x64, 0x5c, 0x09, 0xbc, 0xfc, 0xa0, 
  0x5a, 0xbe, 0xbc, 0xa0, 0x01, 0xbe, 0xfc, 0x28, 0xf1, 0xbf, 0xbc, 0x80, 0x5a, 0xbe, 0xbc, 0x80, 
  0x66, 0xc0, 0xbc, 0x5c, 0x5f, 0xac, 0xbc, 0xa0, 0xf1, 0xad, 0xbc, 0x84, 0x00, 0xac, 0x7c, 0xc1, 
  0x20, 0x00, 0x4c, 0x5c, 0xf2, 0xb7, 0x3c, 0x61, 0x01, 0xba, 0xfc, 0x30, 0x1f, 0xbc, 0xfc, 0xe4, 
  0x17, 0xba, 0xfc, 0x28, 0xff, 0xba, 0xfc, 0x60, 0x01, 0xb2, 0x7c, 0x62, 0xff, 0xba, 0xd4, 0x6c, 
  0xf0, 0xaf, 0xbc, 0x08, 0x5c, 0xae, 0xbc, 0x80, 0x57, 0xba, 0x3c, 0x00, 0x5c, 0xae, 0xbc, 0x84, 
  0x01, 0xae, 0xfc, 0x80, 0x0f, 0xae, 0xfc, 0x60, 0xf0, 0xaf, 0x3c, 0x08, 0x17, 0x00, 0x7c, 0x5c, 
  0x60, 0xcc, 0xbc, 0x5c, 0xf0, 0xad, 0xbc, 0xa0, 0x08, 0xac, 0xfc, 0x80, 0x56, 0xae, 0xbc, 0x08, 
  0x04, 0xac, 0xfc, 0x80, 0x56, 0xb0, 0xbc, 0x08, 0x58, 0xae, 0x3c, 0x86, 0x34, 0x00, 0x68, 0x5c, 
  0x62, 0xb0, 0xbc, 0x80, 0x58, 0xc6, 0xbc, 0x00, 0x62, 0xb0, 0xbc, 0x84, 0x01, 0xb0, 0xfc, 0x80, 
  0x0f, 0xb0, 0xfc, 0x60, 0x56, 0xb0, 0x3c, 0x08, 0x00, 0xc7, 0xfc, 0x68, 0x02, 0xc6, 0xfc, 0x2c, 
  0x01, 0xc6, 0xfc, 0x68, 0x0b, 0xc8, 0xfc, 0xa0, 0xf1, 0xcb, 0xbc, 0xa0, 0x04, 0xb2, 0x7c, 0x62, 
  0x02, 0xb2, 0x7c, 0x61, 0x01, 0xc6, 0xe0, 0x6c, 0x01, 0xc6, 0xfc, 0x29, 0x61, 0xe8, 0xab, 0x70, 
  0x61, 0xec, 0x97, 0x74, 0x5a, 0xca, 0xbc, 0x80, 0x60, 0xcc, 0xbc, 0x5c, 0x65, 0xac, 0xbc, 0xa0, 
  0xf1, 0xad, 0xbc, 0x84, 0x00, 0xac, 0x7c, 0xc1, 0x4e, 0x00, 0x4c, 0x5c, 0x47, 0xc8, 0xfc, 0xe4, 
  0x34, 0x00, 0x7c, 0x5c, 0x00, 0x00, 0x00, 0x00, 
};
int32_t FullDuplexSerial::Start(int32_t Rxpin, int32_t Txpin, int32_t Mode, int32_t Baudrate)
{
  int32_t _parm__0000[4];
  int32_t Okay = 0;
  _parm__0000[0] = Rxpin;
  _parm__0000[1] = Txpin;
  _parm__0000[2] = Mode;
  _parm__0000[3] = Baudrate;
  Stop();
  Txlock = locknew();
  Strlock = locknew();
  { int32_t _fill__0001; int32_t *_ptr__0003 = (int32_t *)&Rx_head; int32_t _val__0002 = 0; for (_fill__0001 = 4; _fill__0001 > 0; --_fill__0001) {  *_ptr__0003++ = _val__0002; } };
  memmove( (void *)&Rx_pin, (void *)&_parm__0000[0], 4*(3));
  Bit_ticks = (CLKFREQ / _parm__0000[3]);
  Buffer_ptr = (int32_t)(&Rx_buffer);
  Okay = (Cog = (cognew((int32_t)(&(*(int32_t *)&dat[0])), (int32_t)(&Rx_head)) + 1));
  return Okay;
}

int32_t FullDuplexSerial::Stop(void)
{
  int32_t result = 0;
  if (Cog) {
    cogstop((PostEffect__(Cog, 0) - 1));
    lockret(Txlock);
    lockret(Strlock);
  }
  { int32_t _fill__0004; int32_t *_ptr__0006 = (int32_t *)&Rx_head; int32_t _val__0005 = 0; for (_fill__0004 = 9; _fill__0004 > 0; --_fill__0004) {  *_ptr__0006++ = _val__0005; } };
  return result;
}

int32_t FullDuplexSerial::Rxflush(void)
{
  int32_t result = 0;
  while (Rxcheck() >= 0) {
    Yield__();
  }
  return result;
}

int32_t FullDuplexSerial::Rxcheck(void)
{
  int32_t Rxbyte = 0;
  (Rxbyte--);
  if (Rx_tail != Rx_head) {
    Rxbyte = Rx_buffer[Rx_tail];
    Rx_tail = ((Rx_tail + 1) & 0xf);
  }
  return Rxbyte;
}

int32_t FullDuplexSerial::Rxready(void)
{
  int32_t result = 0;
  return -(Rx_head != Rx_tail);
}

int32_t FullDuplexSerial::Rxtime(int32_t Ms)
{
  int32_t	T;
  int32_t Rxbyte = 0;
  T = CNT;
  while (!(((Rxbyte = Rxcheck()) >= 0) || (((CNT - T) / (CLKFREQ / 1000)) > Ms))) {
    Yield__();
  }
  return Rxbyte;
}

int32_t FullDuplexSerial::Rx(void)
{
  int32_t Rxbyte = 0;
  while ((Rxbyte = Rxcheck()) < 0) {
    Yield__();
  }
  return Rxbyte;
}

int32_t FullDuplexSerial::Tx(int32_t Txbyte)
{
  int32_t result = 0;
  while (lockset(Txlock)) {
    Yield__();
  }
  while (!(Tx_tail != ((Tx_head + 1) & 0xf))) {
    Yield__();
  }
  Tx_buffer[Tx_head] = Txbyte;
  Tx_head = ((Tx_head + 1) & 0xf);
  lockclr(Txlock);
  if (Rxtx_mode & 0x8) {
    Rx();
  }
  return result;
}

int32_t FullDuplexSerial::Str(int32_t Stringptr)
{
  int32_t result = 0;
  while (lockset(Strlock)) {
    Yield__();
  }
  {
    int32_t _idx__0007;
    _idx__0007 = strlen((char *) Stringptr);
    do {
      Tx(((uint8_t *)(Stringptr++))[0]);
      _idx__0007 = (_idx__0007 + -1);
    } while (_idx__0007 >= 1);
  }
  lockclr(Strlock);
  return result;
}

int32_t FullDuplexSerial::Dec(int32_t Value)
{
  int32_t	I, X;
  int32_t result = 0;
  X = -(Value == (int32_t)0x80000000U);
  if (Value < 0) {
    Value = (abs((Value + X)));
    Tx('-');
  }
  I = 1000000000;
  {
    int32_t _idx__0008;
    _idx__0008 = 10;
    do {
      if (Value >= I) {
        Tx((((Value / I) + '0') + (X * -(I == 1))));
        Value = (Value % I);
        result = -1;
      } else {
        if ((result) || (I == 1)) {
          Tx('0');
        }
      }
      I = (I / 10);
      _idx__0008 = (_idx__0008 + -1);
    } while (_idx__0008 >= 1);
  }
  return result;
}

int32_t FullDuplexSerial::Hex(int32_t Value, int32_t Digits)
{
  int32_t result = 0;
  static int32_t look__0009[] = {48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 65, 66, 67, 68, 69, 70, };

  Value = (Value << ((8 - Digits) << 2));
  {
    int32_t _idx__0010;
    _idx__0010 = Digits;
    do {
      Tx(Lookup__(((Value = (Rotl__(Value, 4))) & 0xf), 0, look__0009, 16));
      _idx__0010 = (_idx__0010 + -1);
    } while (_idx__0010 >= 1);
  }
  return result;
}

int32_t FullDuplexSerial::Bin(int32_t Value, int32_t Digits)
{
  int32_t result = 0;
  Value = (Value << (32 - Digits));
  {
    int32_t _idx__0011;
    _idx__0011 = Digits;
    do {
      Tx((((Value = (Rotl__(Value, 1))) & 0x1) + '0'));
      _idx__0011 = (_idx__0011 + -1);
    } while (_idx__0011 >= 1);
  }
  return result;
}

